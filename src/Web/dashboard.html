<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Premium - Reserva de Assentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .movie-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .movie-card:hover { transform: translateY(-8px); border-color: #3b82f6; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .seat-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .seat-btn:hover:not(:disabled) { transform: scale(1.15); z-index: 10; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .screen-glow { height: 4px; background: linear-gradient(90deg, transparent, #3b82f6, transparent); filter: blur(4px); box-shadow: 0 0 20px #3b82f6; }
        .checkout-bar { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-200 min-h-screen" x-data="cinemaApp()" x-init="init()">

    <!-- Login Moderno -->
    <div x-show="!isLoggedIn" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#0f172a]">
        <div class="glass p-10 rounded-[2.5rem] w-full max-w-md shadow-2xl relative z-10">
            <div class="text-center mb-10">
                <div class="inline-block p-4 bg-blue-600/20 rounded-2xl mb-4 text-3xl">üé¨</div>
                <h2 class="text-3xl font-extrabold tracking-tighter text-white uppercase italic">Cinema <span class="text-blue-500">Premium</span></h2>
            </div>
            <form @submit.prevent="authMode === 'login' ? login() : register()" class="space-y-5">
                <input type="text" x-model="loginForm.username" class="w-full bg-slate-900/50 border border-slate-700 rounded-2xl px-5 py-4 outline-none" placeholder="Usu√°rio">
                <input type="password" x-model="loginForm.password" class="w-full bg-slate-900/50 border border-slate-700 rounded-2xl px-5 py-4 outline-none" placeholder="Senha">
                <button type="submit" class="w-full bg-blue-600 py-5 rounded-2xl font-bold uppercase tracking-widest text-xs">Entrar</button>
                <button type="button" @click="authMode = (authMode === 'login' ? 'register' : 'login')" class="w-full text-xs text-slate-500 py-2">Criar Conta</button>
            </form>
        </div>
    </div>

    <!-- Interface Principal -->
    <div x-show="isLoggedIn" x-cloak class="flex flex-col min-h-screen">
        <header class="glass sticky top-0 z-40 border-b border-white/5 px-6 py-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-10">
                    <h1 @click="view = 'catalog'; selectedSeats = []" class="text-xl font-black italic tracking-tighter cursor-pointer group">CINEMA <span class="text-blue-500">PREMIUM</span></h1>
                    <nav class="hidden md:flex gap-6 text-[10px] font-bold uppercase tracking-widest text-slate-400">
                        <a @click="view = 'catalog'; selectedSeats = []" class="hover:text-white cursor-pointer" :class="view === 'catalog' ? 'text-blue-500' : ''">Filmes</a>
                        <a @click="fetchMyReservations()" class="hover:text-white cursor-pointer" :class="view === 'my-reservations' ? 'text-blue-500' : ''">Minhas Reservas</a>
                    </nav>
                </div>
                <div class="flex items-center gap-6 text-[10px] font-bold">
                    <button @click="initSeed()" class="bg-white/5 px-4 py-2 rounded-xl uppercase opacity-50 hover:opacity-100">Resetar Cat√°logo</button>
                    <p class="text-white" x-text="userName"></p>
                    <button @click="logout()" class="text-rose-500">‚úï</button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto p-6 md:p-10 w-full">
            <!-- Cat√°logo -->
            <div x-show="view === 'catalog'" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <template x-for="movie in movies" :key="movie.id">
                    <div class="movie-card glass rounded-[2.5rem] overflow-hidden group" @click="selectMovie(movie)">
                        <img :src="movie.posterUrl" class="w-full h-[480px] object-cover">
                        <div class="p-8">
                            <h3 class="text-2xl font-extrabold text-white uppercase italic" x-text="movie.title"></h3>
                            <p class="text-slate-400 text-sm mt-4 line-clamp-2" x-text="movie.description"></p>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Sess√µes -->
            <div x-show="view === 'sessions'" class="max-w-4xl mx-auto space-y-8">
                <button @click="view = 'catalog'" class="text-xs font-bold uppercase tracking-widest text-slate-500">‚Üê Cat√°logo</button>
                <h2 class="text-5xl font-black tracking-tighter uppercase italic" x-text="selectedMovie?.title"></h2>
                <div class="flex gap-4">
                    <template x-for="state in ['SP', 'RJ', 'MG']">
                        <button @click="selectedState = state" :class="selectedState === state ? 'bg-blue-600 text-white' : 'text-slate-500 border border-slate-700'" class="px-8 py-3 rounded-2xl text-[10px] font-black uppercase" x-text="state"></button>
                    </template>
                </div>
                <div class="grid gap-4">
                    <template x-for="session in filteredSessions" :key="session.id">
                        <div @click="selectSession(session)" class="glass p-8 rounded-3xl flex justify-between items-center hover:bg-white/5 cursor-pointer">
                            <div><p class="text-[10px] text-slate-500 font-bold uppercase mb-1" x-text="session.theaterName"></p><p class="text-4xl font-black" x-text="formatDate(session.date)"></p></div>
                            <span class="bg-blue-600 text-white px-8 py-4 rounded-2xl text-xs font-black uppercase">Reservar</span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Assentos -->
            <div x-show="view === 'seats'" class="max-w-5xl mx-auto space-y-8">
                <button @click="view = 'sessions'; selectedSeats = []" class="text-xs font-bold uppercase tracking-widest text-slate-500">‚Üê Hor√°rios</button>
                <div class="glass p-12 md:p-20 rounded-[4rem] relative">
                    <div x-show="tempSeat" class="absolute inset-0 bg-[#0f172a]/98 z-50 flex items-center justify-center p-10 rounded-[4rem]">
                        <div class="max-w-md w-full space-y-8">
                            <h3 class="text-3xl font-black uppercase italic text-blue-400">Tipo de Ingresso</h3>
                            <div class="grid gap-4">
                                <button @click="addSelectedSeat('INTEIRA')" class="glass p-8 rounded-3xl text-left flex justify-between items-center">
                                    <div><p class="font-black uppercase">Inteira</p></div><p class="text-2xl font-black text-emerald-400" x-text="formatCurrency(tempSeat?.price)"></p>
                                </button>
                                <button @click="addSelectedSeat('MEIA')" class="glass p-8 rounded-3xl text-left flex justify-between items-center">
                                    <div><p class="font-black uppercase">Meia Entrada</p></div><p class="text-2xl font-black text-emerald-400" x-text="formatCurrency(tempSeat?.price / 2)"></p>
                                </button>
                            </div>
                            <button @click="tempSeat = null" class="w-full text-[10px] font-bold uppercase opacity-50">Cancelar</button>
                        </div>
                    </div>
                    <div class="screen-glow mb-24"></div>
                    <div class="grid grid-cols-10 gap-4 justify-items-center mb-20 max-w-2xl mx-auto">
                        <template x-for="seat in seats" :key="seat.id">
                            <button @click="handleSeatClick(seat)" :disabled="seat.isReserved" :class="getSeatClass(seat)" class="seat-btn w-11 h-11 rounded-xl flex flex-col items-center justify-center transition-all border-b-4 relative">
                                <span x-show="seat.type === 'Wheelchair'" class="text-[16px] mb-[-4px]">‚ôø</span>
                                <span class="text-[10px] font-black" x-text="seat.row + seat.number"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Minhas Reservas -->
            <div x-show="view === 'my-reservations'" class="max-w-5xl mx-auto space-y-10">
                <h2 class="text-4xl font-extrabold tracking-tighter text-white uppercase italic">Meus <span class="text-blue-500">Tickets</span></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <template x-for="res in myReservations" :key="res.id">
                        <div class="glass p-8 rounded-[2.5rem] border border-white/5 relative overflow-hidden group hover:border-blue-500/30 transition-all">
                            <div class="flex justify-between items-start mb-6">
                                <div><p class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-1" x-text="res.seat.movieTitle"></p><p class="text-2xl font-black text-white italic uppercase" x-text="'Assento ' + res.seat.row + res.seat.number"></p></div>
                                <span :class="res.status === 1 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'" class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest" x-text="res.status === 1 ? 'Confirmado' : 'Pendente'"></span>
                            </div>
                            <div class="flex justify-between items-end pt-6 border-t border-white/5">
                                <div><p class="text-[9px] font-bold text-slate-500 uppercase">Data</p><p class="text-sm font-bold text-slate-300" x-text="new Date(res.seat.showDate).toLocaleString('pt-BR')"></p></div>
                                <div class="text-right"><p class="text-[9px] font-bold text-slate-500 uppercase">Pago</p><p class="text-xl font-black text-white" x-text="formatCurrency(res.price)"></p></div>
                            </div>
                            <div class="absolute -right-4 top-1/2 -translate-y-1/2 w-8 h-8 bg-[#0f172a] rounded-full border border-white/5"></div>
                            <div class="absolute -left-4 top-1/2 -translate-y-1/2 w-8 h-8 bg-[#0f172a] rounded-full border border-white/5"></div>
                        </div>
                    </template>
                </div>
                <div x-show="myReservations.length === 0" class="text-center py-20 glass rounded-[3rem] border-dashed border-2 border-slate-700 opacity-50">Voc√™ n√£o possui reservas.</div>
            </div>
        </main>

        <!-- Checkout Bar -->
        <div x-show="selectedSeats.length > 0" class="checkout-bar fixed bottom-0 left-0 w-full glass border-t border-white/10 p-8 z-[100] shadow-2xl">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-6">
                    <div class="bg-blue-600 w-16 h-16 rounded-[1.5rem] flex flex-col items-center justify-center shadow-lg"><span class="text-2xl font-black" x-text="selectedSeats.length"></span><span class="text-[8px] font-black uppercase opacity-70">Tickets</span></div>
                    <div class="flex gap-2"><template x-for="s in selectedSeats" :key="s.id"><div class="bg-white/5 px-4 py-2 rounded-xl"><p class="text-xs font-black" x-text="s.row + s.number"></p></div></template></div>
                </div>
                <div class="flex items-center gap-10">
                    <div class="text-right"><p class="text-[10px] font-black uppercase text-slate-500 mb-1">Total</p><p class="text-4xl font-black text-white tracking-tighter" x-text="formatCurrency(totalPrice)"></p></div>
                    <button @click="confirmBooking()" :disabled="processing" class="bg-blue-600 px-14 py-5 rounded-2xl font-black uppercase tracking-widest text-xs hover:scale-105 transition-all">Finalizar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toasts -->
    <div x-show="toast.show" x-transition class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] w-full max-w-md">
        <div class="glass p-5 rounded-3xl shadow-2xl flex items-center gap-4 mx-4" :class="toast.success ? 'border-emerald-500/30' : 'border-rose-500/30'">
            <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl bg-slate-900/50" x-text="toast.success ? '‚úì' : '‚úï'"></div>
            <p class="text-sm font-medium text-slate-300" x-text="toast.message"></p>
        </div>
    </div>

    <script>
        function cinemaApp() {
            return {
                isLoggedIn: !!localStorage.getItem('token'),
                token: localStorage.getItem('token'),
                userName: localStorage.getItem('user'),
                authMode: 'login',
                view: 'catalog',
                selectedState: 'SP',
                movies: [],
                sessions: [],
                seats: [],
                selectedMovie: null,
                selectedSession: null,
                selectedSeats: [],
                myReservations: [],
                tempSeat: null,
                loading: false,
                processing: false,
                toast: { show: false, message: '', success: true },
                loginForm: { username: '', password: '' },
                urls: { booking: '/api/reservations', movies: '/api/movies', identity: '/api/auth' },

                get filteredSessions() { return this.sessions.filter(s => s.location === this.selectedState); },
                get totalPrice() { return this.selectedSeats.reduce((sum, s) => sum + s.finalPrice, 0); },

                init() { if (this.isLoggedIn) this.fetchMovies(); },

                async fetchMyReservations() {
                    this.view = 'my-reservations';
                    try {
                        const res = await fetch(`${this.urls.booking}/my`, { headers: { 'Authorization': `Bearer ${this.token}` } });
                        if (res.ok) this.myReservations = await res.json();
                    } catch (e) { this.showToast('Erro ao carregar hist√≥rico.', false); }
                },

                handleSeatClick(seat) {
                    const index = this.selectedSeats.findIndex(s => s.id === seat.id);
                    if (index > -1) { this.selectedSeats.splice(index, 1); }
                    else {
                        if (this.selectedSeats.length >= 8) { this.showToast('Limite de 8 assentos.', false); return; }
                        this.tempSeat = seat;
                    }
                },

                addSelectedSeat(type) {
                    const price = type === 'INTEIRA' ? this.tempSeat.price : this.tempSeat.price / 2;
                    this.selectedSeats.push({ ...this.tempSeat, ticketType: type, finalPrice: price });
                    this.tempSeat = null;
                },

                getSeatClass(seat) {
                    if (seat.isReserved) return 'bg-slate-800 text-slate-600 border-transparent opacity-30';
                    if (this.selectedSeats.some(s => s.id === seat.id)) return 'bg-blue-600 text-white border-blue-400 shadow-lg scale-110 z-10';
                    switch(seat.type) {
                        case 'Wheelchair': return 'bg-blue-500/20 text-blue-400 border-blue-500/30';
                        case 'Companion': return 'bg-blue-300/20 text-blue-300 border-blue-300/30';
                        default: return 'bg-emerald-600/20 text-emerald-500 border-emerald-500/30';
                    }
                },

                async confirmBooking() {
                    this.processing = true;
                    try {
                        const payload = {
                            seats: this.selectedSeats.map(s => ({ seatId: s.id, price: s.finalPrice, ticketType: s.ticketType })),
                            userId: this.userName
                        };
                        const res = await fetch(this.urls.booking, {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.token}` },
                            body: JSON.stringify(payload)
                        });
                        if (res.ok) {
                            this.showToast('Reserva confirmada!', true);
                            this.selectedSeats = [];
                            await this.fetchSeats();
                        } else {
                            const data = await res.json();
                            this.showToast(data.message || 'Falha na reserva.', false);
                        }
                    } catch (e) { this.showToast('Erro de conex√£o.', false); }
                    finally { this.processing = false; }
                },

                formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0); },
                formatDate(d) { return new Date(d).getHours() + ':' + new Date(d).getMinutes().toString().padStart(2, '0'); },
                showToast(m, s) { this.toast = { show: true, message: m, success: s }; setTimeout(() => this.toast.show = false, 4000); },
                
                async login() {
                    this.loading = true;
                    try {
                        const res = await fetch(`${this.urls.identity}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.loginForm) });
                        if (res.ok) { const data = await res.json(); localStorage.setItem('token', data.token); localStorage.setItem('user', data.user); location.reload(); }
                        else { this.showToast('Credenciais inv√°lidas.', false); }
                    } finally { this.loading = false; }
                },
                async register() {
                    this.loading = true;
                    try {
                        const res = await fetch(`${this.urls.identity}/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.loginForm) });
                        if (res.ok) { this.showToast('Conta criada!', true); this.authMode = 'login'; }
                    } finally { this.loading = false; }
                },
                logout() { localStorage.clear(); location.reload(); },
                async fetchMovies() {
                    const res = await fetch(this.urls.movies, { headers: { 'Authorization': `Bearer ${this.token}` } });
                    if (res.ok) this.movies = await res.json();
                },
                async selectMovie(movie) {
                    this.selectedMovie = movie;
                    const res = await fetch(`${this.urls.movies}/${movie.id}/sessions`, { headers: { 'Authorization': `Bearer ${this.token}` } });
                    if (res.ok) { this.sessions = await res.json(); this.view = 'sessions'; }
                },
                async selectSession(session) { this.selectedSession = session; await this.fetchSeats(); this.view = 'seats'; },
                async fetchSeats() {
                    const res = await fetch(`${this.urls.booking}/seats/${this.selectedSession.id}`, { headers: { 'Authorization': `Bearer ${this.token}` } });
                    if (res.ok) this.seats = await res.json();
                },
                async initSeed() {
                    await fetch(`${this.urls.booking}/seed`, { method: 'POST', headers: { 'Authorization': `Bearer ${this.token}` } });
                    this.showToast('Cat√°logo reiniciado!', true);
                    location.reload();
                }
            }
        }
    </script>
</body>
</html>
